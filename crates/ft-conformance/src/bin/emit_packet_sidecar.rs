#![forbid(unsafe_code)]

use std::env;
use std::error::Error;
use std::fs;
use std::path::PathBuf;

use ft_serialize::generate_raptorq_sidecar;
use serde_json::json;

fn main() -> Result<(), Box<dyn Error>> {
    let packet_id = env::args().nth(1).ok_or_else(|| {
        std::io::Error::new(
            std::io::ErrorKind::InvalidInput,
            "usage: emit_packet_sidecar <FT-P2C-00X>",
        )
    })?;

    let repo_root = PathBuf::from(env!("CARGO_MANIFEST_DIR")).join("../..");
    let packet_dir = repo_root.join("artifacts/phase2c").join(&packet_id);
    let parity_path = packet_dir.join("parity_report.json");

    let payload = fs::read_to_string(&parity_path)?;
    let (sidecar, proof) = generate_raptorq_sidecar(payload.as_str(), 4)?;

    let sidecar_json = json!({
        "artifact_id": format!("{packet_id}-parity-report"),
        "artifact_type": "conformance",
        "source_hash": sidecar.source_hash,
        "raptorq": {
            "schema_version": sidecar.schema_version,
            "symbol_size": sidecar.symbol_size,
            "k": sidecar.source_symbol_count,
            "constraints": sidecar.constraints_symbol_count,
            "repair_symbols": sidecar.repair_symbol_count,
            "seed": sidecar.seed,
            "object_id_high": sidecar.object_id_high,
            "object_id_low": sidecar.object_id_low,
            "repair_manifest": sidecar.repair_manifest
        },
        "scrub": {
            "status": "ok",
            "last_ok_unix_ms": 0
        },
        "notes": "Generated via ft-serialize::generate_raptorq_sidecar"
    });

    let decode_json = json!({
        "artifact_id": format!("{packet_id}-parity-report"),
        "status": "decode_verified",
        "decode_proof": {
            "schema_version": proof.schema_version,
            "source_hash": proof.source_hash,
            "proof_hash": proof.proof_hash,
            "proof_hash_hex": proof.proof_hash_hex,
            "received_symbol_count": proof.received_symbol_count,
            "recovered_bytes": proof.recovered_bytes
        },
        "notes": "Proof generated by asupersync inactivation decoder"
    });

    fs::write(
        packet_dir.join("parity_report.raptorq.json"),
        serde_json::to_string_pretty(&sidecar_json)?,
    )?;
    fs::write(
        packet_dir.join("parity_report.decode_proof.json"),
        serde_json::to_string_pretty(&decode_json)?,
    )?;

    Ok(())
}
